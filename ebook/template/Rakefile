require 'rake/clean'
require 'pathname'

BUILD_DIR = Pathname('_site')
OUT_DIR = Pathname('_out')
FIXED_DIR = Pathname('_fixed')
FIXED_FILES = FileList[FIXED_DIR / '**/*']

SOURCE_FILES = FileList.new('**/*') do |l|
  l.exclude { |f| File.directory? f }
  l.exclude /^_out/
  l.exclude /^_site/
  l.exclude /-edition.yaml$/
  l.exclude('Rakefile')
end

def edition(name:, excludes: [])
  config_file = Pathname("_#{name}-edition.yaml")
  sources = SOURCE_FILES.clone.exclude(excludes).include(config_file)
  content_dir = BUILD_DIR / name
  opf_file = content_dir / 'package.opf'
  epub_file = OUT_DIR / "#{name}.epub"

  task default: [name]

  desc "Build and check #{name}"
  task name => [epub_file]

  file opf_file => sources do
    sh 'jekyll', 'build', "--destination=#{content_dir}", "--config=_config.yaml,#{config_file}"
  end

  file epub_file => [opf_file, OUT_DIR] + FIXED_FILES do |t|
    epub t.name, content_dir
    sh 'epubcheck', t.name
  end
end

directory OUT_DIR

desc 'Build and check all files'
task :default

edition(name: 'epub')
edition(name: 'mobi', excludes: /^cover/)

def epub(fname, content_dir)
  full_name = File.expand_path(fname)
  rm_f full_name
  cd(FIXED_DIR) do
    sh 'zip', full_name, '-rX0', 'mimetype'
    sh 'zip', full_name, '-rDX9', '.', '-x', 'mimetype'
  end
  cd(content_dir) { sh 'zip', full_name, '-rDX9', '.' }
end

CLEAN.include BUILD_DIR
CLOBBER.include OUT_DIR
