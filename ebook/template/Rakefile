require 'rake/clean'
require 'pathname'
require 'yaml'
require 'rake/ext/pathname'

FIXED_DIR = Pathname('_fixed')
FIXED_FILES = FileList[FIXED_DIR / '**/*']
PUBLICATION = YAML.load_file('_data/publication.yaml')
CONFIG = YAML.load_file('_config.yaml')

SOURCE_FILES = FileList.new('**/*') do |l|
  l.exclude { |f| File.directory? f }
  l.exclude /^_out/
  l.exclude /^_site/
  l.exclude(CONFIG['exclude'])
end

BUILD_DIR = Pathname('_site')
OPF_FILE = BUILD_DIR / 'package.opf'

OUT_DIR = Pathname('_out')
EPUB_FILE = Pathname(ENV['DBP_EPUB_FILE']) || (OUT_DIR / PUBLICATION['slug']).ext('epub').expand_path.to_s
EPUB_CHECK_LOG_FILE = EPUB_FILE.ext('json')
MOBI_FILE = EPUB_FILE.ext('mobi')

directory OUT_DIR

task default: [:all]

desc 'Build and check all formats (default)'
task all: [:check, :mobi]

desc 'Build the epub file'
task epub: [EPUB_FILE]

desc 'Build the mobi file'
task mobi: [MOBI_FILE]

desc 'Check the epub file'
task check: [EPUB_CHECK_LOG_FILE]

directory EPUB_FILE.dirname

file EPUB_FILE => [OPF_FILE, EPUB_FILE.dirname] + FIXED_FILES do |t|
  rm_f t.name
  cd(FIXED_DIR) do
    sh 'zip', t.name, '-rX0', 'mimetype'
    sh 'zip', t.name, '-rDX9', '.', '-x', 'mimetype'
  end
  cd(BUILD_DIR) { sh 'zip', t.name, '-rDX9', '.' }
end

file MOBI_FILE => [EPUB_FILE] do
  sh 'kindlegen', EPUB_FILE
end

file EPUB_CHECK_LOG_FILE => [EPUB_FILE] do |t|
  sh 'epubcheck', EPUB_FILE.to_s, '--json', t.name
end

# This actually builds all of the content files,
# not only the OPF file.
file OPF_FILE => SOURCE_FILES do
  sh 'jekyll', 'build'
end

CLEAN.include BUILD_DIR
CLOBBER.include OUT_DIR
